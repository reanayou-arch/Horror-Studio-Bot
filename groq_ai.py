# ================================
# groq_ai.py
# Horror-Studio AI Engine V2
# –ù–∞—Å—Ç–æ—è—â–∞—è Telegram-–ø–µ—Ä–µ–ø–∏—Å–∫–∞ (–ù–ï —Ä–∞—Å—Å–∫–∞–∑)
# ================================

import os
import requests

# ================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Groq API
# ================================
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

GROQ_URL = "https://api.groq.com/openai/v1/chat/completions"

MODEL = "llama-3.1-8b-instant"


# ================================
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ Horror-Chat
# ================================
def generate_story_reply(story, characters, user_message):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —Å—Ç–∏–ª–µ Horror-Studio:

    - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–ø–∏—Å–∫–∞
    - –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    - –º–∞–∫—Å–∏–º—É–º 2‚Äì4 —Ä–µ–ø–ª–∏–∫–∏
    - –±–µ–∑ —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫–∞
    - –ª–æ–≥–∏–∫–∞ –∏ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è
    """

    title, description, hero_past, start_scene = story

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    char_text = ""
    for c in characters:
        name, role, personality, known = c
        char_text += f"- {name} ({role}, {personality}, {known})\n"

    # ================================
    # –ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç Horror-Studio V2
    # ================================
    system_prompt = f"""
–¢—ã ‚Äî –¥–≤–∏–∂–æ–∫ Horror-Studio.  
–¢—ã –ù–ï –ø–∏—à–µ—à—å —Ä–∞—Å—Å–∫–∞–∑.  
–¢—ã —Å–æ–∑–¥–∞—ë—à—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É –≤ Telegram.

‚ùó –ü—Ä–∞–≤–∏–ª–∞:
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –∫–∞–∫ –≤ —á–∞—Ç–µ.
- –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.
- –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–≥–æ: –ò–º—è: —Ç–µ–∫—Å—Ç
- –°–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–∏–µ, –∂–∏–≤—ã–µ, —Å –ø—É–Ω–∫—Ç—É–∞—Ü–∏–µ–π.
- –ú–∞–∫—Å–∏–º—É–º 2‚Äì4 —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ "–∏–≥—Ä–æ–∫", "—Å–æ–æ–±—â–µ–Ω–∏–µ", "–æ—Ç–≤–µ—Ç".
- –ù–ï –æ–ø–∏—Å—ã–≤–∞–π –¥–µ–π—Å—Ç–≤–∏—è –∫–∞–∫ —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫.
- –°—é–∂–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–∞—à–Ω—ã–º, –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–º –∏ –ª–æ–≥–∏—á–Ω—ã–º.
- –í—Å–µ —Å–æ–±—ã—Ç–∏—è —Å—Ç—Ä–æ–≥–æ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∞–≤—Ç–æ—Ä–∞.

üìñ –ò—Å—Ç–æ—Ä–∏—è:
–ù–∞–∑–≤–∞–Ω–∏–µ: {title}
–û–ø–∏—Å–∞–Ω–∏–µ: {description}

–ü—Ä–æ—à–ª–æ–µ –≥–µ—Ä–æ—è:
{hero_past}

–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞:
{start_scene}

–ü–µ—Ä—Å–æ–Ω–∞–∂–∏:
{char_text}

–ò–≥—Ä–æ–∫ ‚Äî –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π. –û–Ω –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∞–º.
–û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –æ—Ç–≤–µ—á–∞—é—Ç.
"""

    # ================================
    # –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Groq
    # ================================
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_message}
    ]

    # ================================
    # –ó–∞–ø—Ä–æ—Å –≤ Groq
    # ================================
    headers = {
        "Authorization": f"Bearer {GROQ_API_KEY}",
        "Content-Type": "application/json"
    }

    payload = {
        "model": MODEL,
        "messages": messages,
        "temperature": 0.8,
        "max_tokens": 200
    }

    response = requests.post(GROQ_URL, json=payload, headers=headers)

    if response.status_code != 200:
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

    result = response.json()

    return result["choices"][0]["message"]["content"]
