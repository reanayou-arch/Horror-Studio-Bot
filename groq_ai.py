# ================================
# groq_ai.py
# Horror-Studio AI Engine V3
# MEMORY + LOGIC + TELEGRAM STYLE
# ================================

import os
import requests


# ================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Groq API
# ================================
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

GROQ_URL = "https://api.groq.com/openai/v1/chat/completions"

MODEL = "llama-3.1-8b-instant"


# ================================
# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
# ================================
def generate_story_reply(story, characters, dialog_context, user_message):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç AI –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É Horror-Studio.

    story           -> –¥–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏
    characters      -> —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    dialog_context  -> –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–∞–º—è—Ç—å)
    user_message    -> –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
    """

    title, description, hero_past, start_scene = story

    # ----------------------------
    # –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (–∞–Ω–∫–µ—Ç—ã)
    # ----------------------------
    char_text = ""
    for c in characters:
        name, role, personality, known = c
        char_text += f"- {name}: {role}, —Ö–∞—Ä–∞–∫—Ç–µ—Ä: {personality}, —Å—Ç–∞—Ç—É—Å: {known}\n"

    # ----------------------------
    # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    # ----------------------------
    context_text = ""
    for sender, text in dialog_context:
        if sender == "player":
            context_text += f"–ò–≥—Ä–æ–∫: {text}\n"
        else:
            context_text += f"–ü–µ—Ä—Å–æ–Ω–∞–∂–∏: {text}\n"

    # ----------------------------
    # SYSTEM PROMPT Horror-Studio V3
    # ----------------------------
    system_prompt = f"""
–¢—ã ‚Äî Horror-Studio Engine.

–¢—ã —Å–æ–∑–¥–∞—ë—à—å –ù–ï —Ä–∞—Å—Å–∫–∞–∑.
–¢—ã —Å–æ–∑–¥–∞—ë—à—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É –≤ Telegram.

====================================================
‚ùó –ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:

1. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–ò–º—è: —Å–æ–æ–±—â–µ–Ω–∏–µ

2. –¢–æ–ª—å–∫–æ —á–∞—Ç. –ù–∏–∫–∞–∫–∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π –∞–≤—Ç–æ—Ä–∞.
–ù–ï –ø–∏—à–∏: "–æ–Ω –ø–æ—à—ë–ª", "–≤–¥—Ä—É–≥ —Å–ª—É—á–∏–ª–æ—Å—å", "—Å—Ü–µ–Ω–∞".

3. –°–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ –∂–∏–≤—ã–µ.
–ö–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–µ –ª—é–¥–∏ –≤ Telegram.

4. –ú–∞–∫—Å–∏–º—É–º 2‚Äì4 —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –æ—Ç–≤–µ—Ç.

5. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –ù–ï –º–æ–≥—É—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ —É–º–∏—Ä–∞—Ç—å,
–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –±—ã–ª–æ —Å–æ–±—ã—Ç–∏–µ–º —Å—é–∂–µ—Ç–∞.

6. –í—Å–µ–≥–¥–∞ —Å–æ–±–ª—é–¥–∞–π –ª–æ–≥–∏–∫—É:
- –∫—Ç–æ —Ä—è–¥–æ–º
- –∫—Ç–æ –∂–∏–≤
- —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

7. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π.

8. –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å:
–Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ–π, —Å—Ç—Ä–∞—à–Ω–æ–π, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π.

====================================================

üìñ –ò—Å—Ç–æ—Ä–∏—è:
–ù–∞–∑–≤–∞–Ω–∏–µ: {title}

–û–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞:
{description}

–ü—Ä–æ—à–ª–æ–µ –≥–µ—Ä–æ—è:
{hero_past}

–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞:
{start_scene}

–ü–µ—Ä—Å–æ–Ω–∞–∂–∏:
{char_text}

====================================================

–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (–ø–∞–º—è—Ç—å):

{context_text}

====================================================

–ò–≥—Ä–æ–∫ –Ω–∞–ø–∏—Å–∞–ª –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

{user_message}

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—Ç—å –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞.
"""

    # ----------------------------
    # –ó–∞–ø—Ä–æ—Å –≤ Groq
    # ----------------------------
    headers = {
        "Authorization": f"Bearer {GROQ_API_KEY}",
        "Content-Type": "application/json"
    }

    payload = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": system_prompt}
        ],
        "temperature": 0.75,
        "max_tokens": 220
    }

    response = requests.post(GROQ_URL, json=payload, headers=headers)

    if response.status_code != 200:
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

    result = response.json()
    return result["choices"][0]["message"]["content"]
